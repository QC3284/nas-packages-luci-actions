name: Build ImmortalWrt Packages

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  push:
    tags: 
      - 'v*'         # æ ‡ç­¾æŽ¨é€æ—¶è§¦å‘
  schedule:
    - cron: '0 2 * * 1'  # æ¯å‘¨ä¸€å‡Œæ™¨2ç‚¹è‡ªåŠ¨æž„å»º
  pull_request:       # PR æ—¶è§¦å‘

env:
  SDK_URL: "https://downloads.immortalwrt.org/releases/24.10.4/targets/mediatek/filogic/immortalwrt-sdk-24.10.4-mediatek-filogic_gcc-13.3.0_musl.Linux-x86_64.tar.zst"
  CONFIG_URL: "https://raw.githubusercontent.com/QC3284/nas-packages-luci-actions/main/test.config.txt"

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
          gettext git libncurses5-dev libssl-dev python3-setuptools rsync \
          swig unzip zlib1g-dev file wget axel zstd p7zip-full

    - name: Download ImmortalWrt SDK
      run: |
        axel -n 8 -o sdk.tar.zst ${{ env.SDK_URL }}

    - name: Extract SDK
      run: |
        tar -I zstd -xvf sdk.tar.zst

    - name: Setup environment and feeds
      run: |
        cd immortalwrt-sdk-24.10.4-mediatek-filogic_gcc-13.3.0_musl.Linux-x86_64
        
        # æ·»åŠ æ‰€æœ‰è½¯ä»¶æº
        echo 'src-git nas https://github.com/linkease/nas-packages.git;master' >> feeds.conf.default
        echo 'src-git nas_luci https://github.com/linkease/nas-packages-luci.git;main' >> feeds.conf.default
        echo 'src-git istore https://github.com/linkease/istore;main' >> feeds.conf.default
        
        # æ›´æ–°å¹¶å®‰è£…æ‰€æœ‰feeds
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        # ç‰¹åˆ«å®‰è£…iStoreå•†åº—åŠå…¶ä¾èµ–
        ./scripts/feeds install -d y -p istore luci-app-store

    - name: Download config
      run: |
        cd immortalwrt-sdk-24.10.4-mediatek-filogic_gcc-13.3.0_musl.Linux-x86_64
        wget ${{ env.CONFIG_URL }} -O .config

    - name: Compile All Packages
      run: |
        cd immortalwrt-sdk-24.10.4-mediatek-filogic_gcc-13.3.0_musl.Linux-x86_64
        # ç¼–è¯‘ quickstart åŒ…
        make package/feeds/nas_luci/luci-app-quickstart/compile -j$(nproc)
        # ç¼–è¯‘ iStore ç›¸å…³åŒ…
        make package/feeds/istore/luci-app-store/compile -j$(nproc)
        make package/feeds/istore/luci-lib-taskd/compile -j$(nproc)
        make package/feeds/istore/luci-lib-xterm/compile -j$(nproc)

    - name: Get current date
      id: date
      run: echo "date=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

    - name: Find and list IPK files
      id: find-ipk
      run: |
        cd immortalwrt-sdk-24.10.4-mediatek-filogic_gcc-13.3.0_musl.Linux-x86_64
        
        # æŸ¥æ‰¾æ‰€æœ‰ç›¸å…³IPKæ–‡ä»¶
        QUICKSTART_FILES=$(find bin/packages/aarch64_cortex-a53/ -name "*quickstart*" -type f 2>/dev/null | tr '\n' ' ' || echo "")
        ISTORE_FILES=$(find bin/packages/aarch64_cortex-a53/ -name "*istore*" -type f 2>/dev/null | tr '\n' ' ' || echo "")
        STORE_DEPS_FILES=$(find bin/packages/aarch64_cortex-a53/ \( -name "*taskd*" -o -name "*xterm*" \) -type f 2>/dev/null | tr '\n' ' ' || echo "")
        
        ALL_FILES="$QUICKSTART_FILES $ISTORE_FILES $STORE_DEPS_FILES"
        
        echo "Found IPK files:"
        for file in $ALL_FILES; do
          if [ -f "$file" ]; then
            echo "  - $file"
            ls -la "$file"
          fi
        done
        
        # ç»Ÿè®¡æ–‡ä»¶æ•°é‡
        FILE_COUNT=$(echo "$ALL_FILES" | wc -w)
        echo "Total files found: $FILE_COUNT"
        echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
        echo "ipk_files=$ALL_FILES" >> $GITHUB_OUTPUT

    - name: Upload IPK files as artifact
      uses: actions/upload-artifact@v4
      with:
        name: compiled-ipk-packages
        path: |
          immortalwrt-sdk-24.10.4-mediatek-filogic_gcc-13.3.0_musl.Linux-x86_64/bin/packages/aarch64_cortex-a53/**/*quickstart*
          immortalwrt-sdk-24.10.4-mediatek-filogic_gcc-13.3.0_musl.Linux-x86_64/bin/packages/aarch64_cortex-a53/**/*store*    # å·²ä¿®æ”¹
          immortalwrt-sdk-24.10.4-mediatek-filogic_gcc-13.3.0_musl.Linux-x86_64/bin/packages/aarch64_cortex-a53/**/*taskd*
          immortalwrt-sdk-24.10.4-mediatek-filogic_gcc-13.3.0_musl.Linux-x86_64/bin/packages/aarch64_cortex-a53/**/*xterm*
        retention-days: 30

    - name: Create Automatic Release
      if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule' || (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/'))
      uses: softprops/action-gh-release@v2
      with:
        tag_name: auto-build-${{ github.run_id }}-${{ github.run_attempt }}
        name: "Auto Build #${{ github.run_number }}"
        body: |
          ## ImmortalWrt Packages Auto Build
          
          **Build Information:**
          - Run ID: ${{ github.run_id }}
          - Run Number: ${{ github.run_number }}
          - Trigger: ${{ github.event_name }}
          - Commit: ${{ github.sha }}
          - Date: ${{ steps.date.outputs.date }}
          - Files Count: ${{ steps.find-ipk.outputs.file_count }}
          
          **Built Packages:**
          - QuickStart packages
          - iStore packages (luci-app-store, luci-lib-taskd, luci-lib-xterm)
          
          **Download:** All IPK files are attached below.
          
          This is an automated build of packages for ImmortalWrt.
        draft: false
        prerelease: true
        files: |
          immortalwrt-sdk-24.10.4-mediatek-filogic_gcc-13.3.0_musl.Linux-x86_64/bin/packages/aarch64_cortex-a53/**/*quickstart*
          immortalwrt-sdk-24.10.4-mediatek-filogic_gcc-13.3.0_musl.Linux-x86_64/bin/packages/aarch64_cortex-a53/**/*istore*
          immortalwrt-sdk-24.10.4-mediatek-filogic_gcc-13.3.0_musl.Linux-x86_64/bin/packages/aarch64_cortex-a53/**/*taskd*
          immortalwrt-sdk-24.10.4-mediatek-filogic_gcc-13.3.0_musl.Linux-x86_64/bin/packages/aarch64_cortex-a53/**/*xterm*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


    - name: Output build summary
      run: |
        echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Package compilation completed successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Build Date:** ${{ steps.date.outputs.date }}" >> $GITHUB_STEP_SUMMARY
        echo "**Total Files:** ${{ steps.find-ipk.outputs.file_count }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Built Packages:**" >> $GITHUB_STEP_SUMMARY
        echo "- QuickStart (luci-app-quickstart)" >> $GITHUB_STEP_SUMMARY
        echo "- iStore (luci-app-store)" >> $GITHUB_STEP_SUMMARY
        echo "- iStore Dependencies (luci-lib-taskd, luci-lib-xterm)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“¦ Artifacts have been uploaded and will be available for 30 days." >> $GITHUB_STEP_SUMMARY
        if [ "${{ github.event_name }}" = "push" ] && [ "${{ startsWith(github.ref, 'refs/tags/') }}" = "true" ]; then
          echo "ðŸš€ Official release has been published with tag ${{ github.ref_name }}." >> $GITHUB_STEP_SUMMARY
        elif [ "${{ github.event_name }}" = "workflow_dispatch" ] || [ "${{ github.event_name }}" = "schedule" ]; then
          echo "ðŸš€ Automatic pre-release has been published with unique tag." >> $GITHUB_STEP_SUMMARY
        fi
